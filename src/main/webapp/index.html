<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Passenger Booking</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/css/datepicker.min.css">
    <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/datepicker-full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vanillajs-datepicker@1.3.4/dist/js/locales/uk.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>

    <style>
        body { font-family: 'Inter', sans-serif; }
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-height: 90vh;
            overflow-y: auto;
            width: 90%;
            max-width: 600px;
        }
        .autocomplete-results {
            position: absolute;
            background-color: white;
            border: 1px solid #e2e8f0;
            border-radius: 0.375rem;
            max-height: 200px;
            overflow-y: auto;
            z-index: 100;
            width: 100%;
        }
        .autocomplete-item {
            padding: 0.5rem 1rem;
            cursor: pointer;
        }
        .autocomplete-item:hover, .autocomplete-active {
            background-color: #dbeafe;
        }
        #passengers-table-head th, #directory-table-container th {
            cursor: pointer;
        }
        /* Styles for report display */
        #report-display-area {
            font-family: 'Inter', sans-serif;
            padding: 20px;
            color: #000;
            background-color: #fff;
            border: 1px solid #e2e8f0;
            border-radius: 0.5rem;
        }
        #report-display-area h1 {
            font-size: 2rem;
            text-align: center;
        }
        #report-display-area h2, #report-display-area h3 {
            font-weight: bold;
        }
        #report-display-area .report-header {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
            margin-bottom: 2rem;
            font-size: 12px;
        }
        #report-display-area table {
            width: 100%;
            border-collapse: collapse;
            font-size: 10px;
        }
        #report-display-area th, #report-display-area td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: left;
        }
        #report-display-area th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- Auth Status Overlay -->
    <div id="auth-overlay" class="fixed inset-0 bg-gray-100 bg-opacity-75 flex items-center justify-center z-[100]">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <h2 class="text-xl font-semibold mb-2">–ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è...</h2>
            <p id="auth-status-text" class="text-gray-600">–Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è —Ç–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è...</p>
        </div>
    </div>

    <!-- App View -->
    <div id="app-view" class="hidden">
        <!-- Header -->
        <header class="bg-white shadow-md relative overflow-hidden">
            <div class="container mx-auto px-4 py-3 flex justify-between items-center relative" style="z-index: 2;">
                <h1 class="text-xl font-bold text-gray-700">Passenger Booking</h1>
                <nav>
                    <button data-view="main" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">–ì–æ–ª–æ–≤–Ω–∞</button>
                    <button data-view="directories" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">–î–æ–≤—ñ–¥–Ω–∏–∫–∏</button>
                    <button data-view="reports" class="nav-btn px-3 py-2 rounded-md text-sm font-medium text-gray-700 hover:bg-gray-200">–ó–≤—ñ—Ç–∏</button>
                </nav>
            </div>
        </header>

        <!-- Main Content Area -->
        <main id="main-content" class="container mx-auto p-4">
            <!-- Main Page View -->
            <div id="main-page-view">
                <!-- Trip Selection and Info -->
                <div class="bg-white p-4 rounded-lg shadow-md mb-4 flex flex-wrap items-center justify-between gap-4">
                    <div class="flex items-center">
                        <label for="trip-select" class="mr-2 font-semibold">–†–µ–π—Å:</label>
                        <select id="trip-select" class="border border-gray-300 rounded-md p-2"></select>
                    </div>
                    <input type="text" id="passenger-search-input" placeholder="–ü–æ—à—É–∫ –ø–∞—Å–∞–∂–∏—Ä–∞ (F7)..." class="w-full sm:w-auto flex-grow p-2 border border-gray-300 rounded-md">
                    <div id="trip-info" class="text-lg font-bold"></div>
                    <button id="add-passenger-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg">–î–æ–¥–∞—Ç–∏ –ø–∞—Å–∞–∂–∏—Ä–∞</button>
                </div>

                <!-- Passengers Table -->
                <div class="bg-white p-4 rounded-lg shadow-md overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="passengers-table-head" class="bg-gray-50 border-b-2 border-gray-200">
                            <tr>
                                <th id="passenger-date-header" data-sort-key="TripDate" class="p-3 text-sm font-semibold tracking-wide">–î–∞—Ç–∞ –ø–æ—ó–∑–¥–∫–∏</th>
                                <th data-sort-key="ClientName" class="p-3 text-sm font-semibold tracking-wide">–Ü–º'—è –∫–ª—ñ—î–Ω—Ç–∞</th>
                                <th data-sort-key="StationBegin" class="p-3 text-sm font-semibold tracking-wide">–ü—É–Ω–∫—Ç –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è</th>
                                <th data-sort-key="StationEnd" class="p-3 text-sm font-semibold tracking-wide">–ü—É–Ω–∫—Ç –ø—Ä–∏–±—É—Ç—Ç—è</th>
                                <th data-sort-key="Note" class="p-3 text-sm font-semibold tracking-wide">–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                                <th class="p-3 text-sm font-semibold tracking-wide">–î—ñ—ó</th>
                            </tr>
                        </thead>
                        <tbody id="passengers-table-body">
                           <!-- Passenger rows will be inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- Directories Page View -->
            <div id="directories-page-view" class="hidden">
                 <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <div id="directory-tabs" class="flex flex-wrap gap-2 border-b border-gray-200 pb-2 mb-4">
                        <!-- Directory tabs will be inserted here -->
                    </div>
                    <div class="flex justify-between items-center mb-4">
                        <h2 id="directory-title" class="text-2xl font-bold"></h2>
                        <div class="flex items-center gap-4 flex-grow mx-4">
                             <div id="station-filter-container" class="items-center" style="display: none;">
                                 <label for="station-country-filter" class="mr-2 text-sm font-medium">–ö—Ä–∞—ó–Ω–∞:</label>
                                 <select id="station-country-filter" class="p-2 border border-gray-300 rounded-md"></select>
                            </div>
                            <input type="text" id="directory-search-input" placeholder="–ü–æ—à—É–∫..." class="w-full p-2 border border-gray-300 rounded-md">
                        </div>
                        <button id="add-directory-item-btn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg flex-shrink-0">–î–æ–¥–∞—Ç–∏ –∑–∞–ø–∏—Å</button>
                    </div>
                    <div id="directory-table-container" class="overflow-x-auto">
                        <!-- Directory table will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Reports Page View -->
            <div id="reports-page-view" class="hidden">
                <div class="bg-white p-4 rounded-lg shadow-md mb-4">
                    <div>
                        <div class="flex flex-wrap items-center justify-between gap-4 mb-4">
                            <div class="flex items-center">
                                <label for="report-trip-select" class="mr-2 font-semibold">–†–µ–π—Å:</label>
                                <select id="report-trip-select" class="border border-gray-300 rounded-md p-2"></select>
                            </div>
                        </div>
                        <div id="report-buttons" class="flex flex-wrap gap-2 border-t border-gray-200 pt-4 items-center">
                            <button id="generate-passenger-list-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg">–°–ø–∏—Å–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤</button>
                            <button id="generate-surname-list-btn" class="bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg">–°–ø–∏—Å–æ–∫ –ø—Ä—ñ–∑–≤–∏—â</button>
                            <button id="generate-boarding-list-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">–ü–æ—Å–∞–¥–∫–∞</button>
                            <button id="print-report-btn" class="hidden ml-auto bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-4 rounded-lg flex items-center gap-2">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                                  <path d="M2.5 8a.5.5 0 1 0 0-1 .5.5 0 0 0 0 1"/>
                                  <path d="M5 1a2 2 0 0 0-2 2v2H2a2 2 0 0 0-2 2v3a2 2 0 0 0 2 2h1v1a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2v-1h1a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2h-1V3a2 2 0 0 0-2-2zM4 3a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v2H4zM1 7a1 1 0 0 1 1-1h12a1 1 0 0 1 1 1v3a1 1 0 0 1-1 1h-1v-1a2 2 0 0 0-2-2H5a2 2 0 0 0-2 2v1H2a1 1 0 0 1-1-1zm3 4a1 1 0 0 1 1-1h6a1 1 0 0 1 1 1v1H4z"/>
                                </svg>
                                <span>–î—Ä—É–∫</span>
                            </button>
                        </div>
                    </div>
                     <!-- Area to display the generated report -->
                    <div id="report-display-area" class="mt-6 border-t border-gray-200 pt-4">
                        <!-- Report content will be injected here -->
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <!-- Modals -->
    <div id="modal-container"></div>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            doc, 
            setDoc,
            addDoc,
            deleteDoc,
            query, 
            onSnapshot,
            Timestamp,
            getDocs,
            limit,
            where
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        
        // --- YOUR FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyB5ZUtQpehwlwXMWTcP-DtzSLxRRDud054",
            authDomain: "passenger-booking-system-1212.firebaseapp.com",
            projectId: "passenger-booking-system-1212",
            storageBucket: "passenger-booking-system-1212.appspot.com",
            messagingSenderId: "541629107617",
            appId: "1:541629107617:web:75534810970836cc1f8fe0",
            measurementId: "G-JPSBQXPQ54"
        };
       
        // --- UI ELEMENTS ---
        const authOverlay = document.getElementById('auth-overlay');
        const authStatusText = document.getElementById('auth-status-text');
        const appView = document.getElementById('app-view');
        const navButtons = document.querySelectorAll('.nav-btn');
        const mainPageView = document.getElementById('main-page-view');
        const directoriesPageView = document.getElementById('directories-page-view');
        const reportsPageView = document.getElementById('reports-page-view');
        const directoryTabsContainer = document.getElementById('directory-tabs');
        const directoryTitle = document.getElementById('directory-title');
        const addDirectoryItemBtn = document.getElementById('add-directory-item-btn');
        const directorySearchInput = document.getElementById('directory-search-input');
        const directoryTableContainer = document.getElementById('directory-table-container');
        const tripSelect = document.getElementById('trip-select');
        const reportTripSelect = document.getElementById('report-trip-select');
        const passengerSearchInput = document.getElementById('passenger-search-input');
        const tripInfo = document.getElementById('trip-info');
        const passengersTableBody = document.getElementById('passengers-table-body');
        const passengersTableHead = document.getElementById('passengers-table-head');
        const passengerDateHeader = document.getElementById('passenger-date-header');
        const addPassengerBtn = document.getElementById('add-passenger-btn');
        const modalContainer = document.getElementById('modal-container');
        const generatePassengerListBtn = document.getElementById('generate-passenger-list-btn');
        const generateSurnameListBtn = document.getElementById('generate-surname-list-btn');
        const generateBoardingListBtn = document.getElementById('generate-boarding-list-btn');
        const reportDisplayArea = document.getElementById('report-display-area');
        const printReportBtn = document.getElementById('print-report-btn');

        // --- FIREBASE INITIALIZATION ---
        let db;
        try {
            const app = initializeApp(firebaseConfig);
            const auth = getAuth(app);
            db = getFirestore(app);

            // --- AUTHENTICATION LOGIC ---
            const authenticateUser = async () => {
                try {
                    await signInAnonymously(auth);
                } catch (error) {
                    console.error("Authentication Error:", error);
                    if (error.code === 'auth/admin-restricted-operation') {
                        authStatusText.innerHTML = `<b>–ü–æ–º–∏–ª–∫–∞:</b> –ê–Ω–æ–Ω—ñ–º–Ω–∏–π –≤—Ö—ñ–¥ –≤–∏–º–∫–Ω–µ–Ω–æ. <br/><br/> –ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–º–∫–Ω—ñ—Ç—å –π–æ–≥–æ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö –≤–∞—à–æ–≥–æ –ø—Ä–æ—î–∫—Ç—É Firebase: <br/> Authentication -> Sign-in method -> Anonymous -> Enable.`;
                    } else {
                        authStatusText.textContent = `–ü–æ–º–∏–ª–∫–∞ –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó: ${error.message}`;
                    }
                }
            };

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    authStatusText.textContent = '–ê–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö...';
                    await initializeAppLogic();
                    authOverlay.classList.add('hidden');
                    appView.classList.remove('hidden');
                } else {
                    authOverlay.classList.remove('hidden');
                    appView.classList.add('hidden');
                }
            });

            authenticateUser();

        } catch (e) {
            console.error("Initialization Error:", e);
            authStatusText.textContent = `–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${e.message}`;
        }
        
        // --- APPLICATION STATE ---
        const state = {
            currentView: 'main',
            currentDirectory: 'Buses',
            collections: {},
            listeners: {},
            directorySortConfig: { key: 'Plate', direction: 'ascending' },
            passengerSortConfig: { key: 'ClientName', direction: 'ascending' },
            directorySearchTerm: '',
            passengerSearchTerm: '',
            stationCountryFilter: 'all',
            selectedTripId: null
        };

        const DIRECTORIES = {
            Users: { title: '–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ', icon: 'üë§', fields: {username: '–Ü–º\'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞', GoogleAccount: 'Google Account', password: '–ü–∞—Ä–æ–ª—å'} },
            Agents: { title: '–ê–≥–µ–Ω—Ç–∏', icon: 'üßë‚Äçüíº', fields: {Name: '–ù–∞–∑–≤–∞ –∞–≥–µ–Ω—Ç–∞'} },
            Buses: { title: '–ê–≤—Ç–æ–±—É—Å–∏', icon: 'üöå', fields: {Plate: '–ù–æ–º–µ—Ä–Ω–∏–π –∑–Ω–∞–∫', Name: '–ú–æ–¥–µ–ª—å', Capacity: '–ú—ñ—Å—Ç–∫—ñ—Å—Ç—å'} },
            Drivers: { title: '–í–æ–¥—ñ—ó', icon: 'üë®‚Äç‚úàÔ∏è', fields: {Name: '–ü–Ü–ë'} },
            Country: { title: '–ö—Ä–∞—ó–Ω–∏', icon: 'üåç', fields: {Cod: '–ö–æ–¥', Name: '–ù–∞–∑–≤–∞', ISO: 'ISO'} },
            Stations: { title: '–í–æ–∫–∑–∞–ª–∏', icon: 'üè¢', fields: {Name: '–ù–∞–∑–≤–∞', Cod: '–ö–æ–¥', CountryId: '–ö—Ä–∞—ó–Ω–∞', TimeBegin: '–ß–∞—Å –≤—ñ–¥–ø—Ä.', TimeEnd: '–ß–∞—Å –ø—Ä–∏–±.'} },
            Towns: { title: '–ú—ñ—Å—Ç–∞', icon: 'üèôÔ∏è', fields: {Name: '–ù–∞–∑–≤–∞', CountryId: '–ö—Ä–∞—ó–Ω–∞', StationId: '–í–æ–∫–∑–∞–ª'} },
            Clients: { title: '–ö–ª—ñ—î–Ω—Ç–∏', icon: 'üë•', fields: {Name: '–ü–Ü–ë', TownIdUA: '–ú—ñ—Å—Ç–æ (UA)', StationIdUA: '–í–æ–∫–∑–∞–ª (UA)', TownIdEU: '–ú—ñ—Å—Ç–æ (EU)', StationIdEU: '–í–æ–∫–∑–∞–ª (EU)', TelUA: '–¢–µ–ª (UA)', TelEU: '–¢–µ–ª (EU)', NPNum: '‚Ññ –ù–ü'} },
            Routes: { title: '–ú–∞—Ä—à—Ä—É—Ç–∏', icon: 'üó∫Ô∏è', fields: {Cod: '–ö–æ–¥', Name: '–ù–∞–∑–≤–∞', CountryId: '–ö—Ä–∞—ó–Ω–∞', DayOfTheWeek: '–î–µ–Ω—å —Ç–∏–∂–Ω—è'} },
            Trips: { title: '–†–µ–π—Å–∏', icon: 'üìÖ', fields: {Cod: '–ö–æ–¥', RouteId: '–ú–∞—Ä—à—Ä—É—Ç', Date: '–î–∞—Ç–∞', BusId: '–ê–≤—Ç–æ–±—É—Å', DriverId: '–í–æ–¥—ñ–π'} }
        };
        
        const PASSENGER_FIELDS = {
            AgentId: '–ê–≥–µ–Ω—Ç',
            TripId: '–†–µ–π—Å',
            ClientId: '–ö–ª—ñ—î–Ω—Ç',
            Note: '–ü—Ä–∏–º—ñ—Ç–∫–∞'
        };

        const DEFAULT_SORT_CONFIG = {
            Users: { key: 'username', direction: 'ascending' },
            Agents: { key: 'Name', direction: 'ascending' },
            Buses: { key: 'Plate', direction: 'ascending' },
            Drivers: { key: 'Name', direction: 'ascending' },
            Country: { key: 'Cod', direction: 'ascending' },
            Stations: { key: 'Cod', direction: 'ascending' },
            Towns: { key: 'Name', direction: 'ascending' },
            Clients: { key: 'Name', direction: 'ascending' },
            Routes: { key: 'Cod', direction: 'ascending' },
            Trips: { key: 'Cod', direction: 'ascending' }
        };

        const DAY_OF_WEEK_MAP = { "–ù–µ–¥—ñ–ª—è": 0, "–ü–æ–Ω–µ–¥—ñ–ª–æ–∫": 1, "–í—ñ–≤—Ç–æ—Ä–æ–∫": 2, "–°–µ—Ä–µ–¥–∞": 3, "–ß–µ—Ç–≤–µ—Ä": 4, "–ü'—è—Ç–Ω–∏—Ü—è": 5, "–°—É–±–æ—Ç–∞": 6 };

        const FK_MAP = {
            AgentId: 'Agents',
            CountryId: 'Country', StationId: 'Stations', TownIdUA: 'Towns', StationIdUA: 'Stations',
            TownIdEU: 'Towns', StationIdEU: 'Stations', RouteId: 'Routes', BusId: 'Buses',
            DriverId: 'Drivers', TripId: 'Trips', ClientId: 'Clients'
        };

        // --- HELPERS ---
        function formatDate(timestamp, format = 'dd.mm.yy') {
            if (!timestamp || !timestamp.seconds) return 'N/A';
            const date = timestamp.toDate();
            const day = String(date.getDate()).padStart(2, '0');
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const year = date.getFullYear();

            if (format === 'dd.mm.yy') {
                 return `${day}.${month}.${String(year).slice(-2)}`;
            }
            if (format === 'dd.mm.yyyy') {
                return `${day}.${month}.${year}`;
            }
            return `${day}.${month}.${year}`;
        }

        function parseDateString(dateStr) {
            if (!/^\d{2}\.\d{2}\.\d{2}$/.test(dateStr) && !/^\d{2}\.\d{2}\.\d{4}$/.test(dateStr)) return null;
            const parts = dateStr.split('.');
            const day = parseInt(parts[0], 10);
            const month = parseInt(parts[1], 10) - 1;
            let year = parseInt(parts[2], 10);
            if (year < 100) year += 2000;
            
            const date = new Date(Date.UTC(year, month, day));
            if (date.getUTCFullYear() === year && date.getUTCMonth() === month && date.getUTCDate() === day) {
                return date;
            }
            return null;
        }

        // --- DATABASE SEEDING ---
        async function seedDatabase() {
            const seedCollection = async (collectionName, dataFactory) => {
                const collectionRef = collection(db, collectionName);
                const snapshot = await getDocs(query(collectionRef, limit(1)));
                if (snapshot.empty) {
                    console.log(`Seeding ${collectionName}...`);
                    const data = await dataFactory();
                    if (!data) return;
                    for (const item of data) {
                        await addDoc(collectionRef, item);
                    }
                }
            };

            const getDocByField = async (collectionName, field, value) => {
                const q = query(collection(db, collectionName), where(field, "==", value), limit(1));
                const snapshot = await getDocs(q);
                return snapshot.empty ? null : snapshot.docs[0];
            };

            await seedCollection('Country', () => Promise.resolve([ { Cod: 0, Name: "–£–∫—Ä–∞—ó–Ω–∞", ISO: "UA" }, { Cod: 2, Name: "Italia", ISO: "IT" } ]));
            await seedCollection('Drivers', () => Promise.resolve([ { Name: "–•–∞—â–µ–≤–∞—Ü—å–∫–∏–π –û–ª–µ–≥" }, { Name: "–ö–∏–∑–∏–º –õ–µ–æ–Ω—ñ–¥" } ]));
            await seedCollection('Buses', () => Promise.resolve([ { Plate: "BA3474EM", Name: "Setra s431 DT", Capacity: 78 }, { Plate: "BA0205BT", Name: "Neoplan", Capacity: 76 } ]));
            await seedCollection('Agents', () => Promise.resolve([ { Name: "Rubikon" }, { Name: "Sharry" }, { Name: "–í—ñ–∫—Ç–æ—Ä—ñ—è –ú–∞—Ä—Ç–∏–Ω–æ–≤–∞" } ]));
            // NOTE: Storing plain text passwords is not secure. This is for demonstration only.
            // In a real application, password hashing should be handled server-side.
            await seedCollection('Users', () => Promise.resolve([ 
                { username: "Oleh", GoogleAccount: "hop.oleg@gmail.com", password: "password123" },
                { username: "Lena", GoogleAccount: "h.olena.v@gmail.com", password: "password123" },
                { username: "Viola", GoogleAccount: "ukraina.centr@gmail.com", password: "password123" },
                { username: "Artem", GoogleAccount: "forartforces@gmail.com", password: "password123" }
            ]));

            await seedCollection('Stations', async () => {
                const ukraineDoc = await getDocByField('Country', 'Cod', 0);
                const italyDoc = await getDocByField('Country', 'Cod', 2);
                if (!ukraineDoc || !italyDoc) return null;
                return [
                    { Name: "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π", Cod: 1100, CountryId: ukraineDoc.id },
                    { Name: "Roma", Cod: 2100, CountryId: italyDoc.id }
                ];
            });

            await seedCollection('Towns', async () => {
                const ukraineDoc = await getDocByField('Country', 'Cod', 0);
                const italyDoc = await getDocByField('Country', 'Cod', 2);
                const kropStationDoc = await getDocByField('Stations', 'Name', '–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π');
                const romeStationDoc = await getDocByField('Stations', 'Name', 'Roma');
                if (!ukraineDoc || !italyDoc || !kropStationDoc || !romeStationDoc) return null;
                return [
                    { Name: "–ö—Ä–æ–ø–∏–≤–Ω–∏—Ü—å–∫–∏–π", CountryId: ukraineDoc.id, StationId: kropStationDoc.id },
                    { Name: "Bastia", CountryId: italyDoc.id, StationId: romeStationDoc.id }
                ];
            });
        }
        
        // --- MODAL LOGIC ---
        function openConfirmModal(message, onConfirm) {
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content max-w-sm">
                        <h3 class="text-lg font-medium mb-4">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥—ñ—ó</h3>
                        <p class="text-gray-600 mb-6">${message}</p>
                        <div class="flex justify-end">
                            <button class="modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">–ù—ñ</button>
                            <button id="confirm-ok-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg">–¢–∞–∫</button>
                        </div>
                    </div>
                </div>
            `;
            modalContainer.insertAdjacentHTML('beforeend', modalHTML);

            const newModal = modalContainer.lastElementChild;
            const okBtn = newModal.querySelector('#confirm-ok-btn');
            
            okBtn.addEventListener('click', () => {
                onConfirm();
                newModal.remove();
            });
            setupModal(newModal);
        }

        function openDirectoryModal(collectionName, itemId = null, defaults = {}, onSaveCallback = null) {
            const directory = DIRECTORIES[collectionName];
            const isEditing = itemId !== null;
            let item = {};
            
            if (isEditing) {
                item = (state.collections[collectionName] || []).find(i => i.id === itemId) || {};
            } else {
                item = { ...defaults };
                 if ((collectionName === 'Stations' || collectionName === 'Towns') && !item.CountryId) {
                    const ukraine = (state.collections.Country || []).find(c => c.Cod === 0);
                    if (ukraine) item.CountryId = ukraine.id;
                }
            }
            
            const title = `${isEditing ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–î–æ–¥–∞—Ç–∏'} ${directory.title.slice(0, -1).toLowerCase()}`;
            let formFieldsHTML = Object.keys(directory.fields).map(key => generateFormField(key, item[key] || '', collectionName)).join('');

            const modalHTML = `<div class="modal-overlay"><div class="modal-content"><form><h2 class="text-2xl font-bold mb-6">${title}</h2><div class="space-y-4">${formFieldsHTML}</div><div class="flex justify-end mt-6"><button type="button" class="modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div></form></div></div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHTML);
            
            const newModal = modalContainer.lastElementChild;
            const form = newModal.querySelector('form');
            setupModal(newModal, (e) => handleDirectoryFormSubmit(e, collectionName, itemId, onSaveCallback));

            // Setup autocomplete for all FK fields in the modal
            for (const key in directory.fields) {
                if (FK_MAP[key]) {
                    setupAutocomplete(form, key, FK_MAP[key]);
                }
            }
            
            // Show edit buttons for pre-filled fields
            const allHiddenInputs = form.querySelectorAll('input[type="hidden"]');
            allHiddenInputs.forEach(hidden => {
                if (hidden.value) {
                    const key = hidden.name;
                    const editBtn = form.querySelector(`#edit-btn-${key}`);
                    if (editBtn) editBtn.classList.remove('hidden');
                }
            });

            // Smart country default for Stations and Towns
            if (collectionName === 'Stations' || collectionName === 'Towns') {
                const nameInput = form.querySelector('input[name="Name"]');
                const countryAutocompleteInput = form.querySelector('#autocomplete-input-CountryId');
                const countryHiddenInput = form.querySelector('input[name="CountryId"]');
                let userSelectedCountry = !!countryHiddenInput.value;

                countryAutocompleteInput.addEventListener('change', () => userSelectedCountry = true);

                if (nameInput && countryAutocompleteInput && countryHiddenInput) {
                    nameInput.addEventListener('input', () => {
                        if (userSelectedCountry) return;
                        
                        const hasLatinChars = /[a-zA-Z]/.test(nameInput.value);
                        if (hasLatinChars) {
                            const italy = (state.collections.Country || []).find(c => c.Name === 'Italia');
                            if (italy) {
                                countryHiddenInput.value = italy.id;
                                countryAutocompleteInput.value = italy.Name;
                            }
                        } else {
                            const ukraine = (state.collections.Country || []).find(c => c.Cod === 0);
                            if (ukraine) {
                                countryHiddenInput.value = ukraine.id;
                                countryAutocompleteInput.value = ukraine.Name;
                            }
                        }
                    });
                }
            }

            // Time masking for Stations modal
            if (collectionName === 'Stations') {
                const timeInputs = form.querySelectorAll('.time-input');
                timeInputs.forEach(input => {
                    // Add input masking for hh:mm format
                    input.addEventListener('input', (e) => {
                        let value = e.target.value.replace(/[^0-9]/g, '');
                        if (value.length > 2) {
                            value = value.substring(0, 2) + ':' + value.substring(2, 4);
                        }
                        e.target.value = value;
                    });

                    input.addEventListener('blur', (e) => {
                        const value = e.target.value;
                        if (!value || /^\d{2}:\d{2}$/.test(value)) return;
                        let [hours, minutes] = value.split(':');
                        if (parseInt(hours, 10) > 23 || parseInt(minutes, 10) > 59) {
                            e.target.value = ''; // Clear invalid time
                        }
                    });
                });
            }

            if (collectionName === 'Trips') {
                const dateInput = form.querySelector('input[name="Date"]');
                let datepicker;

                const updateAvailableDates = () => {
                    const selectedRouteId = form.querySelector('input[name="RouteId"]').value;
                    if (!selectedRouteId) {
                         if (datepicker) datepicker.destroy();
                         datepicker = new Datepicker(dateInput, { format: 'dd.mm.yy', autohide: true, language: 'uk', weekStart: 1 });
                        return;
                    }

                    const route = state.collections.Routes.find(r => r.id === selectedRouteId);
                    if (!route || !route.DayOfTheWeek) return;

                    const existingTripsForRoute = (state.collections.Trips || []).filter(trip => trip.RouteId === selectedRouteId && trip.id !== itemId);
                    const disabledDates = existingTripsForRoute.map(trip => trip.Date?.toDate()).filter(Boolean);
                    const requiredDay = DAY_OF_WEEK_MAP[route.DayOfTheWeek];
                    
                    if (datepicker) datepicker.destroy();
                    datepicker = new Datepicker(dateInput, {
                        format: 'dd.mm.yy', autohide: true, language: 'uk',
                        daysOfWeekDisabled: [0,1,2,3,4,5,6].filter(d => d !== requiredDay),
                        weekStart: 1, datesDisabled: disabledDates
                    });
                };
                
                const routeObserver = new MutationObserver(updateAvailableDates);
                routeObserver.observe(form.querySelector('input[name="RouteId"]'), { attributes: true, attributeFilter: ['value'] });

                updateAvailableDates();
            }
        }

        function openPassengerModal(passengerId = null) {
            const isEditing = passengerId !== null;
            const passenger = isEditing ? (state.collections.Passengers || []).find(p => p.id === passengerId) : {};
            const title = isEditing ? '–†–µ–¥–∞–≥—É–≤–∞—Ç–∏' : '–î–æ–¥–∞—Ç–∏ –ø–∞—Å–∞–∂–∏—Ä–∞';
            
            let formFieldsHTML = Object.keys(PASSENGER_FIELDS).map(key => generateFormField(key, passenger[key] || '', 'Passengers')).join('');

            const modalHTML = `<div class="modal-overlay"><div class="modal-content"><form><h2 class="text-2xl font-bold mb-6">${title}</h2><div class="space-y-4">
                ${formFieldsHTML}
                <div class="flex items-center space-x-4"><label class="flex items-center"><input type="checkbox" name="Ticket" class="h-4 w-4" ${passenger.Ticket ? 'checked' : ''}><span class="ml-2">–ö–≤–∏—Ç–æ–∫</span></label><label class="flex items-center"><input type="checkbox" name="Status" class="h-4 w-4" ${passenger.Status ? 'checked' : ''}><span class="ml-2">–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ</span></label><label class="flex items-center"><input type="checkbox" name="Place" class="h-4 w-4" ${passenger.Place ? 'checked' : ''}><span class="ml-2">–î–æ–¥–∞—Ç–∫–æ–≤–µ –º—ñ—Å—Ü–µ</span></label></div></div><div class="flex justify-end mt-6"><button type="button" class="modal-close-btn bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg mr-2">–°–∫–∞—Å—É–≤–∞—Ç–∏</button><button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg">–ó–±–µ—Ä–µ–≥—Ç–∏</button></div></form></div></div>`;
            modalContainer.insertAdjacentHTML('beforeend', modalHTML);
            
            const newModal = modalContainer.lastElementChild;
            const form = newModal.querySelector('form');
            if (!isEditing && state.selectedTripId && state.selectedTripId !== 'all') {
                form.querySelector('input[name="TripId"]').value = state.selectedTripId;
                const tripText = getDisplayValue('Passengers', 'TripId', state.selectedTripId);
                form.querySelector(`[data-key="TripId"]`).value = tripText;
            }

            const focusTargetKey = isEditing ? 'ClientId' : (state.selectedTripId && state.selectedTripId !== 'all' ? 'ClientId' : 'AgentId');
            
            setupModal(newModal, (e) => handlePassengerFormSubmit(e, passengerId), `autocomplete-input-${focusTargetKey}`);
            
            for (const key in PASSENGER_FIELDS) {
                if (FK_MAP[key]) {
                    setupAutocomplete(form, key, FK_MAP[key]);
                }
            }
            
            // Show edit buttons for pre-filled fields
            const allHiddenInputs = form.querySelectorAll('input[type="hidden"]');
            allHiddenInputs.forEach(hidden => {
                if (hidden.value) {
                    const key = hidden.name;
                    const editBtn = form.querySelector(`#edit-btn-${key}`);
                    if (editBtn) editBtn.classList.remove('hidden');
                }
            });
        }
        
        function setupModal(modalElement, submitHandler, focusTargetId = null) {
            const form = modalElement.querySelector('form');
            if(submitHandler && form) {
                form.addEventListener('submit', submitHandler);
            }
            modalElement.querySelector('.modal-close-btn').addEventListener('click', () => modalElement.remove());
            
            const focusableElements = 'input:not([type="hidden"]):not(:disabled), textarea:not(:disabled), select, button';
            const focusableContent = Array.from(modalElement.querySelectorAll(focusableElements));
            const firstFocusableElement = focusableContent[0];
            const lastFocusableElement = focusableContent[focusableContent.length - 1];

            setTimeout(() => {
                const focusElement = focusTargetId ? modalElement.querySelector(`#${focusTargetId}`) : null;
                const elementToFocus = focusElement || firstFocusableElement;
                if (elementToFocus) {
                    elementToFocus.focus();
                    if (typeof elementToFocus.select === 'function') {
                        elementToFocus.select();
                    }
                }
            }, 50);

            modalElement.addEventListener('keydown', (e) => {
                const activeAutocomplete = modalElement.querySelector('.autocomplete-results:not(.hidden)');

                // Close on Escape if no autocomplete list is active
                if (e.key === 'Escape' && !activeAutocomplete) {
                    e.preventDefault();
                    modalElement.remove();
                    return;
                }

                // Handle Tab for focus trapping
                if (e.key === 'Tab') {
                    if (e.shiftKey) { // Shift + Tab
                        if (document.activeElement === firstFocusableElement) {
                            lastFocusableElement.focus();
                            e.preventDefault();
                        }
                    } else { // Tab
                        if (document.activeElement === lastFocusableElement) {
                            firstFocusableElement.focus();
                            e.preventDefault();
                        }
                    }
                }

                // Submit on Enter in last field, or move to next
                if (e.key === 'Enter' && !e.shiftKey && form && !activeAutocomplete) {
                    const currentElement = document.activeElement;
                     if (currentElement.tagName === 'BUTTON' && currentElement.type !== 'submit') {
                        return; // Do nothing if Enter is pressed on a non-submit button
                    }
                    
                    e.preventDefault();
                    const inputElements = focusableContent.filter(el => el.tagName !== 'BUTTON');
                    const lastInputElement = inputElements[inputElements.length - 1];

                    if (currentElement === lastInputElement || currentElement.type === 'submit') {
                        form.requestSubmit();
                    } else {
                        const currentIndex = focusableContent.indexOf(currentElement);
                        const nextElement = focusableContent[currentIndex + 1];
                        nextElement?.focus();
                    }
                }
            });
        }
        
        function setupAutocomplete(modalScope, key, collectionName) {
            const input = modalScope.querySelector(`#autocomplete-input-${key}`);
            const hiddenInput = modalScope.querySelector(`input[name="${key}"]`);
            const resultsContainer = modalScope.querySelector(`#autocomplete-results-${key}`);
            const editBtn = modalScope.querySelector(`#edit-btn-${key}`);
            if (!input || !hiddenInput || !resultsContainer) return;
            
            let activeIndex = -1;

            const setActiveItem = () => {
                const items = resultsContainer.querySelectorAll('.autocomplete-item');
                items.forEach((item, index) => item.classList.toggle('autocomplete-active', index === activeIndex));
            };

            const moveToNextField = () => {
                const allFocusable = Array.from(modalScope.querySelectorAll('input:not([type=hidden]), textarea'));
                let currentIndex = allFocusable.indexOf(input);
                let nextElement = allFocusable[currentIndex + 1];

                // Skip auto-filled station field in Client form
                if (input.id.startsWith('autocomplete-input-TownId') && nextElement && nextElement.id.startsWith('autocomplete-input-StationId')) {
                    if (nextElement.value && nextElement.value !== '‚Äî') {
                         nextElement = allFocusable[currentIndex + 2];
                    }
                }

                if (nextElement) {
                    nextElement.focus();
                    if (typeof nextElement.select === 'function') {
                        nextElement.select();
                    }
                } else {
                    modalScope.querySelector('button[type="submit"]')?.focus();
                }
            };
            
            const onSelect = (id, name) => {
                input.value = name;
                hiddenInput.value = id;
                const event = new Event('change', { bubbles: true });
                hiddenInput.dispatchEvent(event);
                resultsContainer.classList.add('hidden');
                activeIndex = -1;
                if(editBtn) editBtn.classList.remove('hidden');

                // New logic for auto-filling station
                if (collectionName === 'Towns') {
                    const town = (state.collections.Towns || []).find(t => t.id === id);
                    if (town && town.StationId) {
                        const station = (state.collections.Stations || []).find(s => s.id === town.StationId);
                        if (station) {
                            const form = input.closest('form');
                            let stationKey;
                            
                            if (key === 'TownIdUA') stationKey = 'StationIdUA';
                            else if (key === 'TownIdEU') stationKey = 'StationIdEU';
                            else if (key === 'TownId') stationKey = 'StationId';
                            
                            if (stationKey && form) {
                                const stationHiddenInput = form.querySelector(`input[name="${stationKey}"]`);
                                const stationVisibleInput = form.querySelector(`#autocomplete-input-${stationKey}`);
                                
                                if (stationHiddenInput && stationVisibleInput) {
                                    stationHiddenInput.value = station.id;
                                    stationVisibleInput.value = station.Name;
                                    const stationEditBtn = form.querySelector(`#edit-btn-${stationKey}`);
                                    if(stationEditBtn) stationEditBtn.classList.remove('hidden');
                                }
                            }
                        }
                    }
                }
            };

            input.addEventListener('input', () => {
                const searchTerm = input.value.toLowerCase();
                hiddenInput.value = '';
                if(editBtn) editBtn.classList.add('hidden');
                activeIndex = -1;
                if (searchTerm.length < 1) {
                    resultsContainer.innerHTML = '';
                    resultsContainer.classList.add('hidden');
                    return;
                }
                const filtered = (state.collections[collectionName] || []).filter(item => getDisplayValue(null, key, item.id).toLowerCase().includes(searchTerm));
                resultsContainer.innerHTML = filtered.length 
                    ? filtered.map(s => `<div class="autocomplete-item" data-id="${s.id}">${getDisplayValue(null, key, s.id)}</div>`).join('')
                    : '<div class="p-2 text-gray-500">–ù–µ –∑–Ω–∞–π–¥–µ–Ω–æ. ‚Üì –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</div>';
                resultsContainer.classList.remove('hidden');
            });

            input.addEventListener('keydown', e => {
                const items = resultsContainer.querySelectorAll('.autocomplete-item');
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    
                    // If list is hidden and input is empty, show the full list
                    if (resultsContainer.classList.contains('hidden') && input.value.trim() === '') {
                        const allItems = (state.collections[collectionName] || []);
                        resultsContainer.innerHTML = allItems.length 
                            ? allItems.map(s => `<div class="autocomplete-item" data-id="${s.id}">${getDisplayValue(null, key, s.id)}</div>`).join('')
                            : '<div class="p-2 text-gray-500">–ù–µ–º–∞—î –∑–∞–ø–∏—Å—ñ–≤. ‚Üì –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è</div>';
                        resultsContainer.classList.remove('hidden');
                        activeIndex = 0;
                        setActiveItem();
                        return;
                    }
                    
                    if (items.length > 0 && activeIndex < items.length - 1) {
                        activeIndex++;
                        setActiveItem();
                    } else { // Handles end of list or empty list (after typing)
                        resultsContainer.classList.add('hidden');
                        const currentValue = input.value.trim();
                        const existingItem = (state.collections[collectionName] || []).find(item =>
                            getDisplayValue(null, key, item.id).toLowerCase() === currentValue.toLowerCase()
                        );

                        if (existingItem && currentValue) {
                            onSelect(existingItem.id, getDisplayValue(null, key, existingItem.id));
                            moveToNextField();
                        } else {
                            const defaultName = DIRECTORIES[collectionName].fields.Name ? { Name: input.value } : {};
                            openDirectoryModal(collectionName, null, defaultName, (newItem) => {
                                onSelect(newItem.id, getDisplayValue(null, key, newItem.id));
                                moveToNextField();
                            });
                        }
                    }
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    if (activeIndex > 0) {
                        activeIndex--;
                        setActiveItem();
                    }
                } else if (e.key === 'Enter') {
                    e.stopPropagation(); // Stop event from bubbling up to the modal's keydown listener
                    e.preventDefault();
                    if (activeIndex > -1 && items[activeIndex]) {
                        // If an item is highlighted, select it
                        items[activeIndex].click(); 
                    } else {
                        // If no item is highlighted, check if current text is a perfect match
                        const currentValue = input.value.trim();
                        const existingItem = (state.collections[collectionName] || []).find(item =>
                            getDisplayValue(null, key, item.id).toLowerCase() === currentValue.toLowerCase()
                        );
                        if (existingItem) {
                            onSelect(existingItem.id, getDisplayValue(null, key, existingItem.id));
                        }
                        // Always move to the next field on Enter
                        moveToNextField();
                    }
                } else if (e.key === 'F4') {
                    e.preventDefault();
                    if (editBtn && !editBtn.classList.contains('hidden')) {
                        editBtn.click();
                    }
                } else if (e.key === 'Escape') {
                    resultsContainer.classList.add('hidden');
                }
            });

            resultsContainer.addEventListener('click', e => {
                if (e.target.classList.contains('autocomplete-item')) {
                    const id = e.target.dataset.id;
                    onSelect(id, e.target.textContent);
                    moveToNextField();
                }
            });
            
            if (editBtn) {
                editBtn.addEventListener('click', () => {
                    const itemId = hiddenInput.value;
                    if (itemId) {
                        const onUpdateCallback = (updatedItem) => {
                            if (updatedItem) {
                                input.value = getDisplayValue(null, key, updatedItem.id);
                            }
                        };
                        openDirectoryModal(collectionName, itemId, {}, onUpdateCallback);
                    } else {
                        alert('–°–ø–æ—á–∞—Ç–∫—É –æ–±–µ—Ä—ñ—Ç—å –∑–∞–ø–∏—Å –¥–ª—è —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è.');
                    }
                });
            }

            document.addEventListener('click', (e) => {
                 if (!e.target.contains(input)) {
                     resultsContainer.classList.add('hidden');
                 }
            });
        }
        
        function generateFormField(key, value, parentCollectionName) {
            const label = DIRECTORIES[parentCollectionName]?.fields[key] || PASSENGER_FIELDS[key] || key;
            let fieldHTML = `<div><label class="block text-sm font-medium text-gray-700 mb-1">${label}</label>`;
            const refCollectionName = FK_MAP[key];

            if (refCollectionName) {
                 const currentName = value ? getDisplayValue(parentCollectionName, key, value) : '';
                 const editIconHTML = `
                    <button type="button" id="edit-btn-${key}" class="hidden absolute inset-y-0 right-0 pr-3 flex items-center text-gray-400 hover:text-gray-600" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –∑–∞–ø–∏—Å (F4)" tabindex="-1">
                        <svg class="h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828zM5 14H3v-2l9-9 2 2-9 9z"/></svg>
                    </button>
                `;
                 fieldHTML += `
                     <div class="relative">
                         <input type="text" id="autocomplete-input-${key}" data-key="${key}" autocomplete="off" value="${currentName}" class="w-full border border-gray-300 rounded-md p-2 pr-10" placeholder="–í–≤–µ–¥—ñ—Ç—å –¥–ª—è –ø–æ—à—É–∫—É...">
                         <input type="hidden" name="${key}" value="${value || ''}">
                         ${editIconHTML}
                         <div id="autocomplete-results-${key}" class="autocomplete-results hidden"></div>
                     </div>`;
            } else if (key === 'DayOfTheWeek') {
                const days = ["–ü–æ–Ω–µ–¥—ñ–ª–æ–∫", "–í—ñ–≤—Ç–æ—Ä–æ–∫", "–°–µ—Ä–µ–¥–∞", "–ß–µ—Ç–≤–µ—Ä", "–ü'—è—Ç–Ω–∏—Ü—è", "–°—É–±–æ—Ç–∞", "–ù–µ–¥—ñ–ª—è"];
                 fieldHTML += `<select name="${key}" class="w-full border border-gray-300 rounded-md p-2">${days.map(day => `<option value="${day}" ${day === value ? 'selected' : ''}>${day}</option>`).join('')}</select>`;
            } else if (key === 'Date') {
                fieldHTML += `<input type="text" name="${key}" value="${value && value.seconds ? formatDate(value) : ''}" class="w-full border border-gray-300 rounded-md p-2" placeholder="–¥–¥.–º–º.—Ä—Ä">`;
            } else if (key === 'TimeBegin' || key === 'TimeEnd') {
                 fieldHTML += `<input type="text" name="${key}" value="${value || ''}" class="w-full border border-gray-300 rounded-md p-2 time-input" placeholder="–≥–≥:—Ö—Ö">`;
            } else if (key === 'password') {
                fieldHTML += `<input type="password" name="${key}" value="${value || ''}" class="w-full border border-gray-300 rounded-md p-2" autocomplete="new-password">`;
            } else if (['Capacity', 'Cod', 'NPNum'].includes(key) || (parentCollectionName === 'Country' && key === 'ISO')) {
                 fieldHTML += `<input type="text" name="${key}" value="${value || ''}" class="w-full border border-gray-300 rounded-md p-2">`;
            } else {
                fieldHTML += `<input type="text" name="${key}" value="${value || ''}" class="w-full border border-gray-300 rounded-md p-2">`;
            }
            return fieldHTML + `</div>`;
        }

        async function handleDirectoryFormSubmit(e, collectionName, itemId, onSaveCallback = null) {
            e.preventDefault();
            const form = e.target;
            const data = Object.fromEntries(new FormData(form).entries());
            let hasError = false;
            Object.keys(data).forEach(key => {
                if (hasError) return;
                if (['Capacity', 'Cod', 'NPNum'].includes(key)) {
                    data[key] = Number(data[key]) || 0;
                }
                if (key === 'Date' && data[key]) {
                    const parsedDate = parseDateString(data[key]);
                     if(parsedDate) {
                        data[key] = Timestamp.fromDate(parsedDate);
                     } else {
                         delete data[key];
                     }
                }
            });

            if (hasError) return;

            if (collectionName === 'Trips') {
                const routeId = data.RouteId;
                const tripDate = data.Date;
                if (routeId && tripDate?.seconds) {
                    const route = state.collections.Routes.find(r => r.id === routeId);
                    if (route) {
                        const date = tripDate.toDate();
                        const year = String(date.getFullYear()).slice(-2);
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        data.Cod = `${year}${month}${day}${route.Cod}`;
                        
                        const q = query(collection(db, 'Trips'), where("Cod", "==", data.Cod));
                        const existing = await getDocs(q);
                        if (!existing.empty && existing.docs[0].id !== itemId) {
                           return alert(`–†–µ–π—Å –∑ –∫–æ–¥–æ–º "${data.Cod}" –≤–∂–µ —ñ—Å–Ω—É—î!`);
                        }
                    } else { return alert("–ù–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –º–∞—Ä—à—Ä—É—Ç."); }
                } else { return alert("–û–±–µ—Ä—ñ—Ç—å –º–∞—Ä—à—Ä—É—Ç —Ç–∞ –¥–∞—Ç—É."); }
            }

            if (collectionName === 'Agents' && data.Name) {
                 const q = query(collection(db, 'Agents'), where("Name", "==", data.Name));
                 const existing = await getDocs(q);
                 if (!existing.empty && existing.docs[0].id !== itemId) {
                    return alert(`–ê–≥–µ–Ω—Ç –∑ –Ω–∞–∑–≤–æ—é "${data.Name}" –≤–∂–µ —ñ—Å–Ω—É—î!`);
                }
            }
            
            if (collectionName === 'Users' && data.username) {
                 const q = query(collection(db, 'Users'), where("username", "==", data.username));
                 const existing = await getDocs(q);
                 if (!existing.empty && existing.docs[0].id !== itemId) {
                    return alert(`–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ —ñ–º–µ–Ω–µ–º "${data.username}" –≤–∂–µ —ñ—Å–Ω—É—î!`);
                }
            }

             if (collectionName === 'Country' && data.ISO) {
                 const q = query(collection(db, 'Country'), where("ISO", "==", data.ISO.toUpperCase()));
                 const existing = await getDocs(q);
                 if (!existing.empty && existing.docs[0].id !== itemId) {
                    return alert(`–ö—Ä–∞—ó–Ω–∞ –∑ ISO –∫–æ–¥–æ–º "${data.ISO.toUpperCase()}" –≤–∂–µ —ñ—Å–Ω—É—î!`);
                }
                data.ISO = data.ISO.toUpperCase();
            }


            try {
                const modal = form.closest('.modal-overlay');
                if (itemId) {
                    await setDoc(doc(db, collectionName, itemId), data, { merge: true });
                     if (onSaveCallback) onSaveCallback({ id: itemId, ...data });
                } else {
                    const newDocRef = await addDoc(collection(db, collectionName), data);
                    if (onSaveCallback) onSaveCallback({ id: newDocRef.id, ...data });
                }
                modal.remove();
            } catch (error) { console.error("Error saving document: ", error); }
        }
        
        async function handlePassengerFormSubmit(e, passengerId) {
            e.preventDefault();
            const formData = new FormData(e.target);
            const data = {
                AgentId: formData.get('AgentId') || null,
                TripId: formData.get('TripId'), 
                ClientId: formData.get('ClientId'), 
                Note: formData.get('Note') || '',
                Ticket: formData.has('Ticket'), 
                Status: formData.has('Status'), 
                Place: formData.has('Place')
            };
            if (!data.TripId || !data.ClientId) return alert("–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–µ–π—Å —Ç–∞ –∫–ª—ñ—î–Ω—Ç–∞.");
            try {
                if (passengerId) {
                    await setDoc(doc(db, 'Passengers', passengerId), data, { merge: true });
                } else {
                    data.Booking = Timestamp.now();
                    await addDoc(collection(db, 'Passengers'), data);
                }
                e.target.closest('.modal-overlay').remove();
            } catch (error) { console.error("Error saving passenger:", error); }
        }

        async function initializeAppLogic() {
            await seedDatabase();
            setupEventListeners();
            renderDirectoryTabs();
            await setupRealtimeListeners();
            switchView('main');
        }
        
        async function setupRealtimeListeners() {
            const allCollections = [...Object.keys(DIRECTORIES), 'Passengers'];
            const promises = allCollections.map(collectionName => {
                return new Promise((resolve, reject) => {
                    if (state.listeners[collectionName]) state.listeners[collectionName]();
                    const q = query(collection(db, collectionName));
                    state.listeners[collectionName] = onSnapshot(q, (snapshot) => {
                        state.collections[collectionName] = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                        if (state.currentView === 'directories' && state.currentDirectory === collectionName) renderDirectoryTable();
                        else if (state.currentView === 'main' || state.currentView === 'reports') {
                            renderMainPage(); // Also updates reports page selector
                            renderReportsPage();
                        }
                        resolve();
                    }, reject);
                });
            });
            await Promise.all(promises);
        }
        
        function switchView(viewName) {
            state.currentView = viewName;
            mainPageView.classList.toggle('hidden', viewName !== 'main');
            directoriesPageView.classList.toggle('hidden', viewName !== 'directories');
            reportsPageView.classList.toggle('hidden', viewName !== 'reports');

            navButtons.forEach(btn => {
                btn.classList.toggle('bg-gray-200', btn.dataset.view === viewName);
            });

            if (viewName === 'main') renderMainPage();
            else if (viewName === 'directories') renderDirectoryPage();
            else if (viewName === 'reports') {
                 renderReportsPage();
                 reportDisplayArea.innerHTML = ''; // Clear previous report
                 printReportBtn.classList.add('hidden'); // Hide print button
            }
        }
        
        function renderDirectoryTabs() {
            directoryTabsContainer.innerHTML = Object.keys(DIRECTORIES).map(key => `<button data-dir="${key}" class="dir-tab-btn flex items-center gap-2 px-4 py-2 text-sm rounded-md ${state.currentView === 'directories' && state.currentDirectory === key ? 'bg-blue-500 text-white' : 'bg-gray-100 hover:bg-gray-200'}"><span class="text-lg">${DIRECTORIES[key].icon}</span><span>${DIRECTORIES[key].title}</span></button>`).join('');
        }

        function populateCountryFilter() {
            const filterSelect = document.getElementById('station-country-filter');
            if (!filterSelect) return;
            const countries = state.collections.Country || [];
            let optionsHTML = '<option value="all">–í—Å—ñ –∫—Ä–∞—ó–Ω–∏</option>';
            optionsHTML += countries
                .sort((a, b) => a.Name.localeCompare(b.Name))
                .map(c => `<option value="${c.id}">${c.Name}</option>`).join('');
            filterSelect.innerHTML = optionsHTML;
            filterSelect.value = state.stationCountryFilter;
        }

        function renderDirectoryPage() {
            directoryTitle.textContent = DIRECTORIES[state.currentDirectory].title;
            const stationFilterContainer = document.getElementById('station-filter-container');
            if (state.currentDirectory === 'Stations') {
                populateCountryFilter();
                stationFilterContainer.style.display = 'flex';
            } else {
                stationFilterContainer.style.display = 'none';
            }
            renderDirectoryTable();
        }

        function renderDirectoryTable() {
            const directory = DIRECTORIES[state.currentDirectory];
            let data = [...(state.collections[state.currentDirectory] || [])];
            
            if (state.currentDirectory === 'Stations' && state.stationCountryFilter !== 'all') {
                data = data.filter(station => station.CountryId === state.stationCountryFilter);
            }

            if (state.directorySearchTerm) {
                const term = state.directorySearchTerm.toLowerCase();
                data = data.filter(item => Object.keys(directory.fields).some(key => 
                    getDisplayValue(state.currentDirectory, key, item[key]).toString().toLowerCase().includes(term)
                ));
            }
            if (state.directorySortConfig.key) {
                const { key, direction } = state.directorySortConfig;
                data.sort((a, b) => (a[key] || '').toString().localeCompare((b[key] || '').toString()) * (direction === 'ascending' ? 1 : -1));
            }
            let tableHTML = `<table class="w-full text-left"><thead class="bg-gray-50 border-b-2 border-gray-200"><tr>${Object.keys(directory.fields).map(key => `<th class="p-3 text-sm font-semibold tracking-wide cursor-pointer" data-sort-key="${key}">${directory.fields[key]} ${state.directorySortConfig.key === key ? (state.directorySortConfig.direction === 'ascending' ? '‚ñ≤' : '‚ñº') : ''}</th>`).join('')}<th class="p-3">–î—ñ—ó</th></tr></thead><tbody>`;
            
            tableHTML += data.map(item => {
                let rowHTML = `<tr class="border-b border-gray-200 hover:bg-gray-50">`;
                for (const key in directory.fields) {
                    if (state.currentDirectory === 'Stations' && key === 'Cod') {
                         rowHTML += `<td class="p-1 text-sm">
                                        <input type="number" 
                                               class="w-full p-2 border rounded-md bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 transition" 
                                               value="${item[key] || ''}" 
                                               data-id="${item.id}" 
                                               data-field="Cod">
                                     </td>`;
                    } else {
                        rowHTML += `<td class="p-3 text-sm">${getDisplayValue(state.currentDirectory, key, item[key])}</td>`;
                    }
                }
                rowHTML += `<td class="p-3"><button class="edit-item-btn" data-id="${item.id}" data-collection="${state.currentDirectory}">‚úèÔ∏è</button><button class="delete-item-btn" data-id="${item.id}" data-name="${item.Name || item.Plate || item.Cod || ''}" data-collection="${state.currentDirectory}">üóëÔ∏è</button></td></tr>`;
                return rowHTML;
            }).join('');

            tableHTML += `</tbody></table>`;
            directoryTableContainer.innerHTML = tableHTML;
        }
        
        function getDisplayValue(parentCollectionName, key, value) {
             if (!value) return '‚Äî';
             const refCollectionName = FK_MAP[key];
             const refItem = refCollectionName ? (state.collections[refCollectionName] || []).find(i => i.id === value) : null;
             
             if (refItem) {
                 if (key === 'TripId') {
                    const route = state.collections.Routes.find(r => r.id === refItem.RouteId);
                    return `${refItem.Date ? formatDate(refItem.Date) : 'N/A'} - ${route ? route.Name : '...'}`;
                 }
                 return refItem.Name || refItem.Plate || refItem.Cod || refItem.username || 'N/A';
             }
             if (key === 'Date' && value.seconds) return formatDate(value);
             return value;
        }

        function renderMainPage() {
            renderTripSelector(tripSelect, 'all');
            renderPassengerTable(tripSelect.value);
        }

        function renderReportsPage() {
            renderTripSelector(reportTripSelect, state.selectedTripId ? state.selectedTripId : null);
        }

        function renderTripSelector(selectorElement, defaultValue = null) {
            const trips = [...(state.collections.Trips || [])].sort((a, b) => String(a.Cod || '').localeCompare(String(b.Cod || '')));
            
            let selectedValue = state.selectedTripId;
            if (!selectedValue && defaultValue) {
                selectedValue = defaultValue;
            }

            let optionsHTML = '';
            if (defaultValue === 'all') {
                optionsHTML += `<option value="all" ${selectedValue === 'all' ? 'selected' : ''}>–ó–∞–≥–∞–ª—å–Ω–∏–π —Å–ø–∏—Å–æ–∫</option>`;
            } else if (!selectedValue) {
                optionsHTML += '<option value="" selected disabled>-- –û–±–µ—Ä—ñ—Ç—å —Ä–µ–π—Å --</option>';
            }

            optionsHTML += trips.map(trip => `<option value="${trip.id}" ${trip.id === selectedValue ? 'selected' : ''}>${getDisplayValue('Passengers', 'TripId', trip.id)}</option>`).join('');
            
            selectorElement.innerHTML = optionsHTML;
            selectorElement.value = selectedValue || ''; // Ensure value is correctly set
        }

        async function handleCopyPassenger(passengerId) {
            const original = (state.collections.Passengers || []).find(p => p.id === passengerId);
            if (!original) return;
            const newData = { ...original, Booking: Timestamp.now() };
            delete newData.id;
            if (tripSelect.value !== 'all') newData.TripId = tripSelect.value;
            await addDoc(collection(db, 'Passengers'), newData);
        }
        
        function renderPassengerTable(tripId = 'all') {
            let passengers = (state.collections.Passengers || []).filter(p => tripId === 'all' || p.TripId === tripId);
            let enriched = passengers.map(p => {
                const client = (state.collections.Clients || []).find(c => c.id === p.ClientId);
                const trip = (state.collections.Trips || []).find(t => t.id === p.TripId);
                const route = trip ? (state.collections.Routes || []).find(r => r.id === trip.RouteId) : null;
                const country = route ? (state.collections.Country || []).find(c => c.id === route.CountryId) : null;
                let stationBegin = '‚Äî', stationEnd = '‚Äî';
                 if (client) {
                    const stUA = (state.collections.Stations || []).find(s => s.id === client.StationIdUA)?.Name || '‚Äî';
                    const stEU = (state.collections.Stations || []).find(s => s.id === client.StationIdEU)?.Name || '‚Äî';
                    stationBegin = country?.Cod === 0 ? stUA : stEU;
                    stationEnd = country?.Cod === 0 ? stEU : stUA;
                 }
                return { ...p, ClientName: client?.Name || '', TripDate: trip?.Date?.toMillis() || 0, StationBegin: stationBegin, StationEnd: stationEnd };
            });

            if (state.passengerSearchTerm) {
                const term = state.passengerSearchTerm.toLowerCase();
                enriched = enriched.filter(p => {
                    return (p.ClientName || '').toLowerCase().includes(term) ||
                           (p.StationBegin || '').toLowerCase().includes(term) ||
                           (p.StationEnd || '').toLowerCase().includes(term) ||
                           (p.Note || '').toLowerCase().includes(term);
                });
            }

            if (state.passengerSortConfig.key) {
                 const { key, direction } = state.passengerSortConfig;
                 enriched.sort((a,b) => (a[key] || '').toString().localeCompare((b[key] || '').toString()) * (direction === 'ascending' ? 1 : -1));
            }
            passengersTableHead.querySelectorAll('th[data-sort-key]').forEach(th => th.innerHTML = `${th.textContent.replace(/[‚ñ≤‚ñº]/g, '').trim()} ${state.passengerSortConfig.key === th.dataset.sortKey ? (state.passengerSortConfig.direction === 'ascending' ? '‚ñ≤' : '‚ñº') : ''}`);
            passengerDateHeader.style.display = tripId === 'all' ? '' : 'none';
            if (tripId !== 'all') {
                const trip = (state.collections.Trips || []).find(t => t.id === tripId);
                const bus = trip ? (state.collections.Buses || []).find(b => b.id === trip.BusId) : null;
                const extraPlaces = passengers.filter(p => p.Place).length;
                const mainPassengers = passengers.length - extraPlaces;
                
                let infoHTML = '';
                if (bus) {
                    const passengerCountColor = mainPassengers > bus.Capacity ? 'text-red-600 font-bold' : 'text-gray-800 font-bold';
                    infoHTML += `<span class="${passengerCountColor}">${mainPassengers}</span>`;
                    infoHTML += `<span class="text-gray-500"> / ${bus.Capacity}</span>`;
                    if (extraPlaces > 0) {
                        infoHTML += ` <span class="text-yellow-500 font-bold">(+${extraPlaces})</span>`;
                    }
                }
                tripInfo.innerHTML = infoHTML;

            } else {
                tripInfo.innerHTML = ''; // Clear when "all" is selected
            }
            passengersTableBody.innerHTML = enriched.map(p => {
                const dateCell = tripId === 'all' ? `<td class="p-3 text-sm">${p.TripDate ? formatDate(Timestamp.fromMillis(p.TripDate)) : ''}</td>` : '';
                return `
                    <tr class="${p.Place ? 'bg-yellow-100' : (p.Status ? 'bg-green-50' : '')} ${p.Ticket ? 'font-bold' : ''} border-b">
                        ${dateCell}
                        <td class="p-3 text-sm">${p.ClientName || ''}</td>
                        <td class="p-3 text-sm">${p.StationBegin}</td>
                        <td class="p-3 text-sm">${p.StationEnd}</td>
                        <td class="p-3 text-sm">${p.Note || ''}</td>
                        <td class="p-3">
                            <button class="status-btn text-xl ${p.Status ? '' : 'opacity-25'}" data-id="${p.id}" title="–ü—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ">‚úÖ</button>
                            <button class="copy-passenger-btn text-gray-500 hover:text-gray-700 ml-2" data-id="${p.id}" title="–î—É–±–ª—é–≤–∞—Ç–∏">üìã</button>
                            <button class="edit-passenger-btn text-blue-500 hover:text-blue-700 ml-2" data-id="${p.id}" title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏">‚úèÔ∏è</button>
                            <button class="delete-passenger-btn text-red-500 hover:text-red-700 ml-2" data-id="${p.id}" data-name="${p.ClientName}" title="–í–∏–¥–∞–ª–∏—Ç–∏">üóëÔ∏è</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        async function generateSurnameListReport() {
            const tripId = reportTripSelect.value;
            if (!tripId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–µ–π—Å –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—É.');
                return;
            }

            const trip = (state.collections.Trips || []).find(t => t.id === tripId);
            if (!trip) {
                alert("–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –æ–±—Ä–∞–Ω–∏–π —Ä–µ–π—Å.");
                return;
            }
            const route = (state.collections.Routes || []).find(r => r.id === trip.RouteId);
            const bus = (state.collections.Buses || []).find(b => b.id === trip.BusId);
            const driver = (state.collections.Drivers || []).find(d => d.id === trip.DriverId);
            
            const passengers = (state.collections.Passengers || [])
                .filter(p => p.TripId === tripId)
                .map(p => {
                    const client = state.collections.Clients.find(c => c.id === p.ClientId);
                    return { ...p, client };
                })
                .sort((a, b) => (a.client?.Name || '').localeCompare(b.client?.Name || ''));

            let listItems = '';
            passengers.forEach((p, index) => {
                const surname = (p.client?.Name || '').split(' ')[0]; // Assuming surname is the first word
                if (surname) {
                    listItems += `<li>${surname}</li>`;
                }
            });

            const reportHTML = `
                <div class="report-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span><strong>${bus?.Plate || ''}</strong> ${bus?.Name || ''}</span>
                        <span style="text-align: right;">${route?.Name || ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>${driver?.Name || ''}</span>
                        <span style="text-align: right; font-weight: bold;">${formatDate(trip?.Date, 'dd.mm.yyyy')}</span>
                    </div>
                </div>
                <h3>–°–ø–∏—Å–æ–∫ –ø–∞—Å–∞–∂–∏—Ä—ñ–≤ (–ø—Ä—ñ–∑–≤–∏—â–∞)</h3>
                <ol style="list-style-type: decimal; padding-left: 20px; font-size: 12px;">
                    ${listItems}
                </ol>
            `;
            
            reportDisplayArea.innerHTML = reportHTML;
            printReportBtn.classList.remove('hidden');
        }

        async function generatePassengerListReport() {
            const tripId = reportTripSelect.value;
            if (!tripId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–µ–π—Å –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—É.');
                return;
            }

            const trip = (state.collections.Trips || []).find(t => t.id === tripId);
            if (!trip) {
                console.error("Trip not found for report:", tripId);
                alert("–ü–æ–º–∏–ª–∫–∞: –Ω–µ –≤–¥–∞–ª–æ—Å—è –∑–Ω–∞–π—Ç–∏ –æ–±—Ä–∞–Ω–∏–π —Ä–µ–π—Å.");
                return;
            }
            const route = (state.collections.Routes || []).find(r => r.id === trip.RouteId);
            const bus = (state.collections.Buses || []).find(b => b.id === trip.BusId);
            const driver = (state.collections.Drivers || []).find(d => d.id === trip.DriverId);
            
            const passengers = (state.collections.Passengers || [])
                .filter(p => p.TripId === tripId)
                .map(p => {
                    const client = state.collections.Clients.find(c => c.id === p.ClientId);
                    const country = route ? state.collections.Country.find(c => c.id === route.CountryId) : null;
                    let stationBegin = '‚Äî', stationEnd = '‚Äî';
                     if (client) {
                        const stUA = state.collections.Stations.find(s => s.id === client.StationIdUA)?.Name || '‚Äî';
                        const stEU = state.collections.Stations.find(s => s.id === client.StationIdEU)?.Name || '‚Äî';
                        stationBegin = country?.Cod === 0 ? stUA : stEU;
                        stationEnd = country?.Cod === 0 ? stEU : stUA;
                     }
                    return { ...p, client, stationBegin, stationEnd };
                })
                .sort((a, b) => (a.client?.Name || '').localeCompare(b.client?.Name || ''));

            let tableRows = '';
            passengers.forEach((p, index) => {
                tableRows += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${p.client?.Name || ''}</td>
                        <td>${p.stationBegin}</td>
                        <td>${p.stationEnd}</td>
                        <td>${p.client?.TelUA || ''}</td>
                        <td>${p.client?.TelEU || ''}</td>
                        <td>${p.Note || ''}</td>
                    </tr>
                `;
            });

            const reportHTML = `
                <div class="report-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span><strong>${bus?.Plate || ''}</strong> ${bus?.Name || ''}</span>
                        <span style="text-align: right;">${route?.Name || ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>${driver?.Name || ''}</span>
                        <span style="text-align: right; font-weight: bold;">${formatDate(trip?.Date, 'dd.mm.yyyy')}</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–ü—Ä—ñ–∑–≤–∏—â–µ –ø–∞—Å–∞–∂–∏—Ä–∞</th>
                            <th>–í–æ–∫–∑–∞–ª –≤—ñ–¥–ø—Ä–∞–≤–∫–∏</th>
                            <th>–í–æ–∫–∑–∞–ª –ø—Ä–∏–±—É—Ç—Ç—è</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω (UA)</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω (EU)</th>
                            <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            `;
            
            reportDisplayArea.innerHTML = reportHTML;
            printReportBtn.classList.remove('hidden');
        }

        async function generateBoardingListReport() {
            const tripId = reportTripSelect.value;
            if (!tripId) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –æ–±–µ—Ä—ñ—Ç—å —Ä–µ–π—Å –¥–ª—è —Ñ–æ—Ä–º—É–≤–∞–Ω–Ω—è –∑–≤—ñ—Ç—É.');
                return;
            }

            const trip = (state.collections.Trips || []).find(t => t.id === tripId);
            if (!trip) { return; }

            const route = (state.collections.Routes || []).find(r => r.id === trip.RouteId);
            const bus = (state.collections.Buses || []).find(b => b.id === trip.BusId);
            const driver = (state.collections.Drivers || []).find(d => d.id === trip.DriverId);

            const passengers = (state.collections.Passengers || [])
                .filter(p => p.TripId === tripId)
                .map(p => {
                    const client = state.collections.Clients.find(c => c.id === p.ClientId);
                    const country = route ? state.collections.Country.find(c => c.id === route.CountryId) : null;
                    
                    const stationBeginId = client ? (country?.Cod === 0 ? client.StationIdUA : client.StationIdEU) : null;
                    const stationEndId = client ? (country?.Cod === 0 ? client.StationIdEU : client.StationIdUA) : null;

                    const stationBegin = state.collections.Stations.find(s => s.id === stationBeginId);
                    const stationEnd = state.collections.Stations.find(s => s.id === stationEndId);
                    
                    return { ...p, client, stationBegin, stationEnd };
                });

            const groupedByStation = passengers.reduce((groups, p) => {
                const stationId = p.stationBegin?.id || 'unknown';
                if (!groups[stationId]) {
                    groups[stationId] = {
                        name: p.stationBegin?.Name || '–ù–µ–≤—ñ–¥–æ–º–æ',
                        code: p.stationBegin?.Cod || 0,
                        passengers: []
                    };
                }
                groups[stationId].passengers.push(p);
                return groups;
            }, {});

            const sortedGroupKeys = Object.keys(groupedByStation).sort((a, b) => groupedByStation[a].code - groupedByStation[b].code);

            let tableBodyHTML = '';
            let passengerCount = 0;
            sortedGroupKeys.forEach(stationId => {
                const group = groupedByStation[stationId];
                tableBodyHTML += `<tr><td colspan="6" style="background-color: #e0e0e0; font-weight: bold;">${group.code} ${group.name}</td></tr>`;
                
                group.passengers.sort((a, b) => (a.client?.Name || '').localeCompare(b.client?.Name || ''));
                
                group.passengers.forEach(p => {
                    passengerCount++;
                    tableBodyHTML += `
                        <tr>
                            <td>${passengerCount}</td>
                            <td>${p.client?.Name || ''}</td>
                            <td>${p.stationEnd?.Name || '‚Äî'}</td>
                            <td>${p.client?.TelUA || ''}</td>
                            <td>${p.client?.TelEU || ''}</td>
                            <td>${p.Note || ''}</td>
                        </tr>
                    `;
                });
            });

            const reportHTML = `
                 <div class="report-header">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span><strong>${bus?.Plate || ''}</strong> ${bus?.Name || ''}</span>
                        <span style="text-align: right;">${route?.Name || ''}</span>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <span>${driver?.Name || ''}</span>
                        <span style="text-align: right; font-weight: bold;">${formatDate(trip?.Date, 'dd.mm.yyyy')}</span>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>‚Ññ</th>
                            <th>–ü—Ä—ñ–∑–≤–∏—â–µ –ø–∞—Å–∞–∂–∏—Ä–∞</th>
                            <th>–í–æ–∫–∑–∞–ª –ø—Ä–∏–±—É—Ç—Ç—è</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω (UA)</th>
                            <th>–¢–µ–ª–µ—Ñ–æ–Ω (EU)</th>
                            <th>–ü—Ä–∏–º—ñ—Ç–∫–∞</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableBodyHTML}
                    </tbody>
                </table>
            `;
            
            reportDisplayArea.innerHTML = reportHTML;
            printReportBtn.classList.remove('hidden');
        }

        function handlePrint() {
            const reportContent = document.getElementById('report-display-area').innerHTML;
            
            const printWindow = window.open('', '', 'height=800,width=1000');
            if (!printWindow) {
                alert('–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–∑–≤–æ–ª—å—Ç–µ —Å–ø–ª–∏–≤–∞—é—á—ñ –≤—ñ–∫–Ω–∞ –¥–ª—è –¥—Ä—É–∫—É.');
                return;
            }

            const now = new Date();
            const printDateTime = `${String(now.getDate()).padStart(2, '0')}.${String(now.getMonth() + 1).padStart(2, '0')}.${now.getFullYear()} ${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;

            const printStyles = `
                @page {
                    size: A4;
                    margin: 0.7in;
                    @bottom-left {
                        content: "${printDateTime}";
                        font-size: 9pt;
                        font-family: sans-serif;
                        color: #555;
                    }
                    @bottom-right {
                        content: counter(page) " / " counter(pages);
                        font-size: 9pt;
                        font-family: sans-serif;
                        color: #555;
                    }
                }
                body { font-family: 'Inter', sans-serif; }
                .report-header {
                    display: flex;
                    flex-direction: column;
                    gap: 0.25rem;
                    margin-bottom: 2rem;
                    font-size: 12px;
                }
                .report-header > div {
                    display: flex;
                    justify-content: space-between;
                    align-items: flex-start;
                }
                table { width: 100%; border-collapse: collapse; font-size: 10pt; }
                th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; }
                h1 { font-size: 2rem; text-align: center; }
            `;
            
            printWindow.document.write('<!DOCTYPE html><html><head><title>–î—Ä—É–∫ –∑–≤—ñ—Ç—É</title>');
            printWindow.document.write('<style>' + printStyles + '</style>');
            printWindow.document.write('</head><body>' + reportContent + '</body></html>');
            
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 500);
        }

        function setupEventListeners() {
            navButtons.forEach(btn => btn.addEventListener('click', () => switchView(btn.dataset.view)));
            directoryTabsContainer.addEventListener('click', e => {
                if (e.target.closest('.dir-tab-btn')) {
                    state.currentDirectory = e.target.closest('.dir-tab-btn').dataset.dir;
                    state.directorySortConfig = DEFAULT_SORT_CONFIG[state.currentDirectory];
                    directorySearchInput.value = ''; state.directorySearchTerm = '';
                    state.stationCountryFilter = 'all'; // Reset filter on tab change
                    renderDirectoryTabs(); 
                    renderDirectoryPage();
                }
            });
            directorySearchInput.addEventListener('input', e => { state.directorySearchTerm = e.target.value; renderDirectoryTable(); });
            const setupSort = (container, configKey, renderFn) => {
                container.addEventListener('click', e => {
                    if (e.target.closest('[data-sort-key]')) {
                        const key = e.target.closest('[data-sort-key]').dataset.sortKey;
                        const config = state[configKey];
                        config.direction = config.key === key && config.direction === 'ascending' ? 'descending' : 'ascending';
                        config.key = key;
                        renderFn();
                    }
                });
            };
            setupSort(directoryTableContainer, 'directorySortConfig', renderDirectoryTable);
            setupSort(passengersTableHead, 'passengerSortConfig', () => renderPassengerTable(tripSelect.value));
            
            directoryTableContainer.addEventListener('change', async (e) => {
                if (e.target.matches('input[data-field="Cod"]') && state.currentDirectory === 'Stations') {
                    const input = e.target;
                    const id = input.dataset.id;
                    const newValue = input.value;

                    if (!id) return;

                    try {
                        const docRef = doc(db, 'Stations', id);
                        await setDoc(docRef, { Cod: Number(newValue) }, { merge: true });

                        input.classList.add('bg-green-100', 'border-green-400');
                        setTimeout(() => {
                            input.classList.remove('bg-green-100', 'border-green-400');
                        }, 1500);

                    } catch (error) {
                        console.error("Error updating station code:", error);
                        input.classList.add('bg-red-100', 'border-red-400');
                        setTimeout(() => {
                            input.classList.remove('bg-red-100', 'border-red-400');
                        }, 2000);
                        alert("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –∫–æ–¥—É.");
                    }
                }
            });

            const stationCountryFilter = document.getElementById('station-country-filter');
            stationCountryFilter.addEventListener('change', e => {
                state.stationCountryFilter = e.target.value;
                renderDirectoryTable();
            });

            passengerSearchInput.addEventListener('input', e => {
                state.passengerSearchTerm = e.target.value;
                renderPassengerTable(tripSelect.value);
            });

            const syncTripSelectors = (source) => {
                const selectedId = source.value;
                state.selectedTripId = selectedId;
                const otherSelect = source.id === 'trip-select' ? reportTripSelect : tripSelect;
                if (otherSelect.value !== selectedId) {
                    otherSelect.value = selectedId;
                }
                if (state.currentView === 'main') {
                    renderPassengerTable(selectedId);
                }
                // Clear report when trip changes on reports page
                if (state.currentView === 'reports') {
                    reportDisplayArea.innerHTML = '';
                    printReportBtn.classList.add('hidden');
                }
            };

            tripSelect.addEventListener('change', () => syncTripSelectors(tripSelect));
            reportTripSelect.addEventListener('change', () => syncTripSelectors(reportTripSelect));
            
            addPassengerBtn.addEventListener('click', () => openPassengerModal());
            addDirectoryItemBtn.addEventListener('click', () => openDirectoryModal(state.currentDirectory));
            generatePassengerListBtn.addEventListener('click', generatePassengerListReport);
            generateSurnameListBtn.addEventListener('click', generateSurnameListReport);
            generateBoardingListBtn.addEventListener('click', generateBoardingListReport);
            printReportBtn.addEventListener('click', handlePrint);
            
            document.body.addEventListener('click', e => {
                const target = e.target.closest('button');
                if (!target) return;
                const { id, name, collection } = target.dataset;
                if (target.matches('.delete-item-btn, .delete-passenger-btn')) {
                    openConfirmModal(`–í–∏ –≤–ø–µ–≤–Ω–µ–Ω—ñ, —â–æ —Ö–æ—á–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ "${name}"?`, () => deleteDoc(doc(db, collection || 'Passengers', id)));
                } else if (target.matches('.status-btn')) {
                    const p = (state.collections.Passengers || []).find(p => p.id === id);
                    if (p) setDoc(doc(db, 'Passengers', id), { Status: !p.Status }, { merge: true });
                } else if (target.matches('.edit-item-btn')) {
                    openDirectoryModal(collection, id);
                } else if (target.matches('.edit-passenger-btn')) {
                    openPassengerModal(id);
                } else if (target.matches('.copy-passenger-btn')) {
                    handleCopyPassenger(id);
                }
            });

            document.addEventListener('keydown', (e) => {
                if (e.key === 'Insert') {
                    // Do not open a new modal if one is already open
                    if (modalContainer.children.length > 0) return;
                    e.preventDefault();
                    if (state.currentView === 'directories') {
                        addDirectoryItemBtn.click();
                    } else if (state.currentView === 'main') {
                        addPassengerBtn.click();
                    }
                }

                if (e.key === 'F7') {
                    e.preventDefault();
                    if (state.currentView === 'main') {
                        passengerSearchInput.focus();
                        passengerSearchInput.select();
                    } else if (state.currentView === 'directories') {
                        directorySearchInput.focus();
                        directorySearchInput.select();
                    }
                }
            });
        }
    </script>
</body>
</html>
