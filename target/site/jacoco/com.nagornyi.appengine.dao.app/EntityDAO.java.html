<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="uk"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>EntityDAO.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">ukraina-centr-admin</a> &gt; <a href="index.source.html" class="el_package">com.nagornyi.appengine.dao.app</a> &gt; <span class="el_source">EntityDAO.java</span></div><h1>EntityDAO.java</h1><pre class="source lang-java linenums">package com.nagornyi.appengine.dao.app;

import com.google.appengine.api.datastore.*;
import com.nagornyi.appengine.dao.DAO;
import com.nagornyi.appengine.entity.EntityWrapper;

import java.util.ArrayList;
import java.util.HashSet;
import java.util.List;
import java.util.Set;
import java.util.logging.Logger;

/**
 * @author Nagorny
 * Date: 25.04.14
 */
<span class="nc" id="L17">public class EntityDAO&lt;E extends EntityWrapper&gt; implements DAO&lt;E&gt; {</span>
<span class="nc" id="L18">    protected Logger log = Logger.getLogger(EntityDAO.class.getName());</span>
<span class="nc" id="L19">    protected DatastoreService datastore = DatastoreServiceFactory.getDatastoreService();</span>

    protected E createDAOEntity(Entity entity) {
<span class="nc" id="L22">        return null;</span>
    }

    protected String getKind() {
<span class="nc" id="L26">        return null;</span>
    }

    protected void logDeletionByKeys(Set&lt;Key&gt; keys) {

<span class="nc" id="L31">    }</span>

    @Override
    public Key create(EntityWrapper wrapper) {
<span class="nc" id="L35">        return datastore.put(wrapper.getEntity());</span>
    }

    @Override
    public E getById(Key id) {
<span class="nc" id="L40">        Query q = new Query(getKind())</span>
<span class="nc" id="L41">                .addFilter(Entity.KEY_RESERVED_PROPERTY,</span>
                        Query.FilterOperator.EQUAL,
                        id);
<span class="nc" id="L44">        PreparedQuery pq = datastore.prepare(q);</span>
<span class="nc" id="L45">        Entity ent = pq.asSingleEntity();</span>
<span class="nc bnc" id="L46" title="All 2 branches missed.">        return ent == null? null : createDAOEntity(ent);</span>
    }

    protected List&lt;E&gt; getByFilter(Query.Filter filter) {
<span class="nc" id="L50">        return getByFilterAndSorting(filter, null, null);</span>
    }

    protected List&lt;E&gt; getByFilterAndSorting(Query.Filter filter, String sortProp, Query.SortDirection dir) {
<span class="nc" id="L54">        return get(null, filter, sortProp, dir);</span>
    }

    protected List&lt;E&gt; get(Key parent, Query.Filter filter, String sortProp, Query.SortDirection dir) {
<span class="nc" id="L58">        Query query = new Query(getKind()).setFilter(filter);</span>
<span class="nc bnc" id="L59" title="All 2 branches missed.">        if (sortProp != null) {</span>
<span class="nc" id="L60">            query.addSort(sortProp, dir);</span>
        }
<span class="nc bnc" id="L62" title="All 2 branches missed.">        if (parent != null) {</span>
<span class="nc" id="L63">            query.setAncestor(parent);</span>
        }
<span class="nc" id="L65">        return getByQuery(query);</span>
    }

    @Override
    public E getByKey(Key key) {
<span class="nc" id="L70">        Entity ent = null;</span>
        try {
<span class="nc" id="L72">            ent = datastore.get(key);</span>
<span class="nc" id="L73">        } catch (EntityNotFoundException e) {</span>
<span class="nc" id="L74">            log.warning(&quot;No entity found for key &quot; +key);</span>
<span class="nc" id="L75">        }</span>
<span class="nc bnc" id="L76" title="All 2 branches missed.">        return ent == null? null : createDAOEntity(ent);</span>
    }

    @Override
    public List&lt;E&gt; getByProperty(String prop, Object propValue) {
<span class="nc" id="L81">        Query q = new Query(getKind())</span>
<span class="nc" id="L82">                .addFilter(prop,</span>
                        Query.FilterOperator.EQUAL,
                        propValue);

<span class="nc" id="L86">        return getByQuery(q);</span>
    }

    public List&lt;E&gt; getByQuery(Query query) {
<span class="nc" id="L90">        List&lt;Entity&gt; entities = datastore.prepare(query).asList(FetchOptions.Builder.withDefaults());</span>
<span class="nc" id="L91">        List&lt;E&gt; result = new ArrayList&lt;E&gt;();</span>
<span class="nc bnc" id="L92" title="All 2 branches missed.">        for (Entity entity: entities) {</span>
<span class="nc" id="L93">            result.add(createDAOEntity(entity));</span>
<span class="nc" id="L94">        }</span>
<span class="nc" id="L95">        return result;</span>
    }

    public int countForQuery(Query query) {
<span class="nc" id="L99">        return datastore.prepare(query).countEntities(FetchOptions.Builder.withDefaults());</span>
    }

    @Override
    public Query getQueryByParent(Key parentKey) {
<span class="nc" id="L104">        return new Query(getKind()).setAncestor(parentKey);</span>
    }

    @Override
    public List&lt;E&gt; getByParent(Key parentKey) {
<span class="nc" id="L109">        Query query = getQueryByParent(parentKey);</span>

<span class="nc" id="L111">        return getByQuery(query);</span>
    }

    @Override
    public List&lt;E&gt; getAll() {
<span class="nc" id="L116">        Query query = new Query(getKind());</span>

<span class="nc" id="L118">        return getByQuery(query);</span>
    }

    @Override
    public List&lt;Key&gt; create(List&lt;E&gt; wrappers) {
<span class="nc" id="L123">        List&lt;Entity&gt; entities = new ArrayList&lt;Entity&gt;(wrappers.size());</span>
<span class="nc bnc" id="L124" title="All 2 branches missed.">        for (EntityWrapper wrapper: wrappers) {</span>
<span class="nc" id="L125">            entities.add(wrapper.getEntity());</span>
<span class="nc" id="L126">        }</span>
<span class="nc" id="L127">        return datastore.put(entities);</span>
    }

    @Override
    public Key save(EntityWrapper wrapper) {
<span class="nc" id="L132">        return create(wrapper);</span>
    }

    @Override
    public List&lt;Key&gt; save(List&lt;E&gt; wrappers) {
<span class="nc" id="L137">        return create(wrappers);</span>
    }

    @Override
    public void delete(E entity) {
<span class="nc" id="L142">        datastore.delete(entity.getEntity().getKey());</span>
<span class="nc" id="L143">    }</span>

    @Override
    public void delete(List&lt;E&gt; es) {
<span class="nc" id="L147">        List&lt;Key&gt; keys = new ArrayList&lt;&gt;(es.size());</span>
<span class="nc bnc" id="L148" title="All 2 branches missed.">        for (E entity: es) {</span>
<span class="nc" id="L149">            keys.add(entity.getKey());</span>
<span class="nc" id="L150">        }</span>
<span class="nc" id="L151">        datastore.delete(keys);</span>
<span class="nc" id="L152">    }</span>

    @Override
    public Set&lt;Key&gt; deleteAll() {
<span class="nc" id="L156">        Query q = new Query(getKind());</span>

<span class="nc" id="L158">        return deleteForQuery(q);</span>
    }

    @Override
    public Set&lt;Key&gt; deleteForQuery(Query query) {
<span class="nc" id="L163">        query.setKeysOnly();</span>
<span class="nc" id="L164">        List&lt;Entity&gt; entities = datastore.prepare(query).asList(FetchOptions.Builder.withDefaults());</span>

<span class="nc" id="L166">        Set&lt;Key&gt; keys = new HashSet&lt;&gt;(entities.size());</span>

<span class="nc bnc" id="L168" title="All 2 branches missed.">        for (Entity e : entities) {</span>
<span class="nc" id="L169">            keys.add(e.getKey());</span>
<span class="nc" id="L170">        }</span>
<span class="nc bnc" id="L171" title="All 2 branches missed.">        if (!keys.isEmpty()) {</span>
<span class="nc" id="L172">            logDeletionByKeys(keys);</span>

<span class="nc" id="L174">            datastore.delete(keys);</span>
        }
<span class="nc" id="L176">        return keys;</span>
    }

    @Override
    public int countAll() {
<span class="nc" id="L181">        return countForQuery(new Query(getKind()));</span>
    }

    public int sanitizeStringProperty(String propertyName) {
<span class="nc" id="L185">        Query.FilterPredicate stringNullFilter = new Query.FilterPredicate(propertyName,</span>
                Query.FilterOperator.EQUAL,
                &quot;null&quot;);
<span class="nc" id="L188">        Query.FilterPredicate nullFilter = new Query.FilterPredicate(propertyName,</span>
                Query.FilterOperator.EQUAL,
                null);
<span class="nc" id="L191">        Query.FilterPredicate emptyStringFilter = new Query.FilterPredicate(propertyName,</span>
                Query.FilterOperator.EQUAL,
                &quot;&quot;);
<span class="nc" id="L194">        Query.FilterPredicate jsUndefinedFilter = new Query.FilterPredicate(propertyName,</span>
                Query.FilterOperator.EQUAL,
                &quot;undefined&quot;);
<span class="nc" id="L197">        Query.Filter resultFilter =</span>
<span class="nc" id="L198">                Query.CompositeFilterOperator.or(stringNullFilter, nullFilter, emptyStringFilter, jsUndefinedFilter);</span>
<span class="nc" id="L199">        List&lt;E&gt; entities = getByFilter(resultFilter);</span>

<span class="nc" id="L201">        int result = entities.size();</span>

<span class="nc bnc" id="L203" title="All 2 branches missed.">        for(E entity: entities) {</span>
<span class="nc" id="L204">            entity.getEntity().removeProperty(propertyName);</span>
<span class="nc" id="L205">        }</span>
<span class="nc" id="L206">        save(entities);</span>

<span class="nc" id="L208">        return result;</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.7.202105040129</span></div></body></html>